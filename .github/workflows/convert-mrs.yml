name: Convert list to mrs

on:
  schedule:
    - cron: "0 0 * * *"   # 每天 00:00 自动运行
  workflow_dispatch:       # 手动触发
  push:
    paths:
      - "Rule/temp/*.list"   # 当 .list 文件更新时自动触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # 允许写入仓库（删除旧文件、提交新文件）

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p .github/temp
          mkdir -p Rule/mrs

      - name: Clean old MRS files
        run: |
          echo "Cleaning old .mrs files..."
          rm -f Rule/mrs/*.mrs || true

      - name: Download Mihomo core
        run: |
          wget -O .github/temp/mihomo https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64
          chmod +x .github/temp/mihomo

      - name: Convert all .list to .mrs
        run: |
          for file in Rule/temp/*.list; do
            name=$(basename "$file" .list)
            echo "Converting $file → Rule/mrs/$name.mrs"
            .github/temp/mihomo convert-ruleset domain text "$file" "Rule/mrs/$name.mrs"
          done

      - name: Commit changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add Rule/mrs/*.mrs
          git commit -m "Auto-update MRS rulesets" || echo "No changes to commit"

      - name: Push changes
        uses: ad-m/github-push-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
